# 音频文件处理功能指南

## 功能概述

Flutter RNN降噪应用已成功集成音频文件选择和处理功能，支持通过流式降噪接口对本地音频文件进行降噪处理，并提供原始音频与处理后音频的播放对比。

## 主要功能

### 1. 音频文件选择
- 支持从设备存储中选择音频文件
- 支持的格式：WAV（推荐）、MP3、M4A、AAC
- 文件选择后自动开始处理

### 2. 流式音频处理
- 使用与实时降噪相同的RNNoise算法
- 48kHz采样率，单声道，480样本帧处理
- 实时进度显示和VAD概率更新

### 3. 音频播放对比
- 播放原始音频文件
- 播放降噪处理后的音频
- 直观对比降噪效果

## 技术实现

### AudioManagerStream 新增方法

#### 文件处理状态
```dart
bool get isFileProcessing  // 文件处理状态
String? get selectedAudioFilePath  // 选择的文件路径
Future<bool> get hasSelectedAudioFiles  // 是否有处理结果
```

#### 核心处理方法
```dart
Future<void> processSelectedAudioFile(String filePath)  // 主处理方法
Future<Float32List> _loadAudioFile(String filePath)  // 音频文件加载
Future<void> _processAudioDataStream(Float32List audioData)  // 流式处理
Future<void> _saveSelectedAudioFiles()  // 保存处理结果
```

#### 播放控制
```dart
Future<void> playSelectedOriginal()  // 播放原始文件
Future<void> playSelectedProcessed()  // 播放处理结果
```

### StreamDemoPage UI 组件

#### 文件处理卡片
- 文件选择按钮，支持加载状态显示
- 选择文件信息展示
- 播放控制按钮（原始/降噪）
- 支持格式说明

## 使用步骤

### 1. 启动应用
确保应用已初始化完成，显示"初始化完成"状态。

### 2. 选择音频文件
1. 点击"选择音频文件"按钮
2. 从文件选择器中选择支持的音频文件
3. 等待文件处理完成

### 3. 播放对比
处理完成后，使用以下按钮对比效果：
- "原始文件"：播放原始音频
- "降噪结果"：播放处理后的音频

## 技术规格

### 音频参数
- **采样率**：48000 Hz
- **声道数**：单声道
- **位深度**：16位PCM
- **帧大小**：480样本

### 支持格式
- **WAV**：推荐格式，最佳兼容性
- **MP3**：常见压缩格式
- **M4A**：Apple音频格式
- **AAC**：高级音频编码

### 输出文件
- 原始文件副本：`{filename}_original.wav`
- 处理结果：`{filename}_processed.wav`
- 保存位置：应用文档目录

## 错误处理

### 常见错误及解决方案

#### "音频文件不存在"
- 检查文件路径是否正确
- 确认文件未被删除或移动

#### "不是有效的WAV文件格式"
- 使用推荐的WAV格式
- 检查文件是否损坏

#### "音频管理器未初始化"
- 等待应用完全启动
- 查看状态显示是否为"初始化完成"

#### "正在处理其他音频文件"
- 等待当前处理完成
- 一次只能处理一个文件

## 性能特点

### 流式处理优势
- 内存使用效率高
- 支持大文件处理
- 实时进度反馈
- 不阻塞UI线程

### 处理速度
- 480样本帧并行处理
- 每50帧让出CPU时间
- 实时VAD概率更新

## 调试功能

### FFI功能测试
点击"运行FFI功能测试"按钮可以：
- 验证RNNoise库加载状态
- 测试噪声抑制效果
- 检查语音信号保留
- 输出详细测试结果

### 测试音频生成
点击"生成带噪声测试音频"可以：
- 创建包含语音+噪声的测试音频
- 验证完整的降噪流程
- 提供标准化的测试样本

## 最佳实践

### 文件选择建议
1. 优先使用WAV格式文件
2. 确保文件采样率为48kHz（或支持转换）
3. 避免选择过大的文件（建议<10MB）

### 使用流程建议
1. 先进行FFI功能测试确认系统正常
2. 使用生成的测试音频验证效果
3. 再处理实际音频文件

### 性能优化
1. 处理大文件时避免同时录音
2. 处理完成后及时播放对比
3. 定期清理临时文件

## 故障排除

### 应用崩溃
1. 检查Flutter和依赖版本
2. 重新安装应用
3. 清除应用数据

### 音频播放问题
1. 检查设备音频权限
2. 确认音频硬件正常
3. 重启音频服务

### 文件处理失败
1. 检查存储权限
2. 确认文件格式支持
3. 验证文件完整性

## 扩展功能

### 未来改进方向
- 支持更多音频格式
- 批量文件处理
- 自定义降噪参数
- 音频质量分析
- 云端处理选项

### 开发者接口
```dart
// 自定义处理参数
class AudioProcessingConfig {
  final int sampleRate;
  final int frameSize;
  final double noiseThreshold;
}

// 处理结果回调
typedef AudioProcessCallback = void Function(AudioProcessResult result);
```

---

**注意**：本功能基于RNNoise算法，主要针对语音信号中的背景噪声进行抑制，对音乐或复杂音频信号的效果可能有限。 